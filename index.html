<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>PANAS GAME TRACKER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root{
            --bg:#1e1e1e;
            --panel: rgba(255,255,255,0.03);
            --accent:#7f1f2d;
            --gold:#B38345;
            --muted:#cfcfcf;
            --btn-bg:#2f2f2f;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #f44336;
        }
        *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
        body{background:linear-gradient(180deg,var(--bg),#111);color:#eee;padding:12px;}
        .container{max-width:980px;margin:0 auto;}
        header{display:flex;align-items:center;justify-content:space-between;padding:10px 6px;margin-bottom:10px;border-radius:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
        header h1{font-size:16px;color:var(--gold);letter-spacing:0.6px;}
        .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
        .action-btn{background:var(--btn-bg);border:1px solid rgba(255,255,255,0.04);color:#eee;padding:7px 9px;border-radius:7px;font-size:13px;cursor:pointer;transition:all 0.2s ease;}
        .action-btn:hover{transform:translateY(-1px);box-shadow:0 2px 4px rgba(0,0,0,0.2);}
        .export-btn{background:var(--gold);color:#111;border:none;}
        .email-btn{background:#4a7fb5;border:none;color:#fff;}
        .toggle-inline{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer;font-size:13px;}
        .game-info{display:grid;grid-template-columns:1fr 160px;gap:8px;margin-bottom:10px;}
        .panel{background:var(--panel);padding:8px;border-radius:8px;}
        label{font-size:12px;color:var(--muted);margin-bottom:6px;display:block;}
        input[type="text"], input[type="date"]{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#eee;font-size:13px;}
        .players-list{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;}
        .player-chip{padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);font-size:13px;cursor:pointer;transition:all 0.2s ease;}
        .player-chip.active{background:linear-gradient(180deg,#7f1f2d,#5e1220);color:#fff;border-color:rgba(0,0,0,0.4);}
        .player-chip:hover{transform:scale(1.05);}

        /* Main area single column */
        .main-area{display:block;}
        .players-column{overflow:auto;max-height:65vh;padding-right:6px;}

        /* Player card */
        .player-card{
            display:flex;
            flex-direction:column;
            gap:8px;
            padding:12px;
            border-radius:8px;
            margin-bottom:10px;
            background:rgba(255,255,255,0.02);
            border-left:4px solid var(--gold);
            font-size:14px;
            transition: all .18s ease;
        }
        .player-card.collapsed{
            padding:10px;
            opacity:0.92;
        }
        .player-card.collapsed .stats-grid{
            display:none;
        }
        .player-top{display:flex;justify-content:space-between;align-items:center;}
        .player-id{font-weight:700;color:var(--gold);font-size:15px;}
        .player-actions{display:flex;gap:6px;}
        .collapse-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer;font-size:13px;}

        .stats-grid{
            display:grid;
            grid-template-columns: repeat(3, 1fr);
            gap:10px;
        }

        .stat-box{
            background: rgba(0,0,0,0.15);
            padding:8px;
            border-radius:8px;
            display:flex;
            flex-direction:column;
            align-items:flex-start;
            gap:8px;
            min-height:64px;
        }

        .stat-label{
            font-size:12px;
            color:var(--muted);
            font-weight:700;
            text-transform:uppercase;
            letter-spacing:0.6px;
        }

        .stat-controls{
            display:flex;
            align-items:center;
            gap:8px;
            width:100%;
        }

        .stat-btn{width:34px;height:34px;border-radius:6px;border:none;background:var(--gold);color:#111;font-weight:800;cursor:pointer;font-size:18px;line-height:1;transition:all 0.2s ease;}
        .stat-btn:hover{background:#d4a862;}
        .stat-btn.minus{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;font-weight:700;}
        .stat-btn.minus:hover{background:rgba(255,255,255,0.05);}
        .stat-input{width:56px;text-align:center;border-radius:6px;padding:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#fff;font-size:14px;}

        .summary-panel{display:flex;gap:6px;margin-bottom:8px;}
        .summary-item{flex:1;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px;text-align:center;font-size:13px;}
        .summary-value{font-weight:700;color:var(--gold);font-size:15px;}

        .history-list{max-height:160px;overflow:auto;margin-top:6px;}
        .history-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px;background:rgba(255,255,255,0.02);margin-bottom:6px;font-size:13px;}
        .history-actions{display:flex;gap:4px;}
        .notification{position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.7);color:#fff;padding:8px 10px;border-radius:8px;display:none;font-size:13px;z-index:1000;}

        .info-collapsed .info-content{display:none;}
        .info-collapsed .players-list{display:none;}

        .quick-stats{display:flex;gap:6px;margin-bottom:8px;}
        .quick-stat{flex:1;background:rgba(255,255,255,0.02);padding:6px;border-radius:6px;text-align:center;font-size:12px;}
        .quick-stat-value{font-weight:700;color:var(--gold);font-size:14px;}

        .player-count{text-align:center;margin:8px 0;font-size:13px;color:var(--muted);}

        @media(max-width:880px){
            .game-info{grid-template-columns:1fr;}
            .stats-grid{grid-template-columns:repeat(2,1fr);}
        }
        @media(max-width:540px){
            .stats-grid{grid-template-columns:1fr;}
            .stat-input{width:48px;}
            .stat-btn{width:30px;height:30px;font-size:16px;}
            .controls{flex-direction:column;align-items:stretch;}
            .action-btn{text-align:center;}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PANAS GAME TRACKER</h1>
            <div class="controls">
                <button class="action-btn export-btn" id="exportBtn">Exportar a Excel</button>
                <button class="action-btn email-btn" id="emailBtn">Enviar por Email</button>
            </div>
        </header>

        <div class="game-info" id="infoSection">
            <div class="panel" id="infoPanel">
                <!-- Cabecera dentro del panel con botón inline -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                    <div style="font-weight:700;color:var(--muted)">INFO DEL PARTIDO</div>
                    <button class="toggle-inline" id="infoCollapseBtn">Ocultar</button>
                </div>

                <div class="info-content">
                    <div class="form-group">
                        <label for="gameDate">Fecha</label>
                        <input type="date" id="gameDate">
                    </div>
                    <div class="form-group">
                        <label for="opponent">Rival</label>
                        <input type="text" id="opponent" placeholder="Rival">
                    </div>
                    <div class="form-group">
                        <label for="venue">Lugar</label>
                        <input type="text" id="venue" placeholder="Lugar">
                    </div>

                    <div class="player-count" id="playerCount">0 jugadores seleccionados</div>

                    <div class="players-list" id="playersList" aria-label="Jugadores seleccionados">
                        <!-- chips -->
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="summary-panel">
                    <div class="summary-item">
                        <div class="summary-value" id="totalRebounds">0</div>
                        <div style="color:var(--muted);font-size:12px;">REBOTES</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalAssists">0</div>
                        <div style="color:var(--muted);font-size:12px;">ASISTENCIAS</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value" id="totalSteals">0</div>
                        <div style="color:var(--muted);font-size:12px;">ROBOS</div>
                    </div>
                </div>

                <div class="quick-stats">
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="totalBlocks">0</div>
                        <div style="color:var(--muted);font-size:11px;">TAPONES</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value" id="totalTurnovers">0</div>
                        <div style="color:var(--muted);font-size:11px;">PÉRDIDAS</div>
                    </div>
                    <div class="quick-stat" style="visibility:hidden">
                        <!-- placeholder para mantener equilibrio visual -->
                        <div class="quick-stat-value">&nbsp;</div>
                        <div style="color:var(--muted);font-size:11px;">&nbsp;</div>
                    </div>
                </div>

                <div style="display:flex;gap:6px;margin-bottom:8px;">
                    <button class="action-btn" id="saveGameBtn">Guardar</button>
                    <button class="action-btn" id="resetGameBtn">Reiniciar</button>
                </div>

                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                    <h4 style="font-size:13px;color:var(--muted);margin:0;">Historial</h4>
                    <button class="action-btn" id="clearHistoryBtn" style="padding:6px 8px;font-size:12px;">Limpiar Historial</button>
                </div>

                <div class="history-list" id="historyList"></div>
            </div>
        </div>

        <div class="main-area">
            <div class="players-column">

                <!-- BOTÓN GLOBAL PARA TODOS LOS JUGADORES -->
                <button class="toggle-inline" id="toggleAllPlayersBtn" style="margin-bottom:10px;">Contraer todos</button>

                <div id="playersContainer"></div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Jugadores de ejemplo (modifica según necesites)
        const allPlayers = [
            { id:0,name:'Javi',number:0 },
            { id:4,name:'Pardo',number:4 },
            { id:5,name:'Betillo',number:5 },
            { id:6,name:'Mesa',number:6 },
            { id:7,name:'Muñoz',number:7 },
            { id:8,name:'Andrew',number:8 },
            { id:9,name:'Reif',number:9 },
            { id:10,name:'Monti',number:10 },
            { id:13,name:'Guille',number:13 },
            { id:17,name:'Cabe',number:17 },
            { id:19,name:'Fuentes',number:19 },
            { id:77,name:'Iñigo',number:77 }
        ];

        let selectedPlayers = [];
        let gameData = { date:'', opponent:'', venue:'' };
        let gameHistory = [];

        function showNotification(text, type='info'){
            const n = document.getElementById('notification');
            n.textContent = text;
            n.style.display = 'block';
            n.style.background = type==='error' ? 'rgba(120,28,28,0.9)' : 
                                type==='success' ? 'rgba(40, 120, 40, 0.9)' : 'rgba(0,0,0,0.7)';
            setTimeout(()=> n.style.display = 'none', 2200);
        }

        // Render chips
        function renderPlayerChips(){
            const container = document.getElementById('playersList');
            container.innerHTML = '';
            allPlayers.forEach(p=>{
                const chip = document.createElement('div');
                chip.className = 'player-chip' + (selectedPlayers.find(s=>s.id===p.id)?' active':'');
                chip.textContent = `${p.number} - ${p.name}`;
                chip.addEventListener('click', ()=> toggleSelectPlayer(p.id));
                container.appendChild(chip);
            });
            updatePlayerCount();
        }

        function updatePlayerCount() {
            document.getElementById('playerCount').textContent = 
                `${selectedPlayers.length} jugador${selectedPlayers.length !== 1 ? 'es' : ''} seleccionado${selectedPlayers.length !== 1 ? 's' : ''}`;
        }

        function toggleSelectPlayer(id){
            const idx = selectedPlayers.findIndex(p=>p.id===id);
            if(idx>=0){
                selectedPlayers.splice(idx,1);
            } else {
                // por defecto collapsed: true
                const pl = { ...allPlayers.find(x=>x.id===id),
                    orebounds:0,drebounds:0,assists:0,steals:0,blocks:0,turnovers:0, collapsed:true
                };
                selectedPlayers.push(pl);
            }
            saveCurrentGameToStorage();
            renderPlayerChips();
            renderPlayers();
            updateSummary();
            updateToggleAllButtonText();
        }

        function renderPlayers(){
            const container = document.getElementById('playersContainer');
            container.innerHTML = '';
            selectedPlayers.forEach(player=>{
                const card = document.createElement('div');
                card.className = 'player-card' + (player.collapsed ? ' collapsed' : '');
                card.innerHTML = `
                    <div class="player-top">
                        <div class="player-id">${player.number} - ${player.name}</div>
                        <div class="player-actions">
                            <button class="collapse-btn" data-id="${player.id}" data-action="toggle">${player.collapsed ? 'Expandir' : 'Contraer'}</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-label">REB. OFENSIVO</div>
                            <div class="stat-controls">
                                <button class="stat-btn minus" data-id="${player.id}" data-stat="orebounds">-</button>
                                <input class="stat-input" data-id="${player.id}" data-stat="orebounds" value="${player.orebounds||0}" readonly>
                                <button class="stat-btn plus" data-id="${player.id}" data-stat="orebounds">+</button>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">REB. DEFENSIVO</div>
                            <div class="stat-controls">
                                <button class="stat-btn minus" data-id="${player.id}" data-stat="drebounds">-</button>
                                <input class="stat-input" data-id="${player.id}" data-stat="drebounds" value="${player.drebounds||0}" readonly>
                                <button class="stat-btn plus" data-id="${player.id}" data-stat="drebounds">+</button>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">ASISTENCIAS</div>
                            <div class="stat-controls">
                                <button class="stat-btn minus" data-id="${player.id}" data-stat="assists">-</button>
                                <input class="stat-input" data-id="${player.id}" data-stat="assists" value="${player.assists||0}" readonly>
                                <button class="stat-btn plus" data-id="${player.id}" data-stat="assists">+</button>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">ROBOS</div>
                            <div class="stat-controls">
                                <button class="stat-btn minus" data-id="${player.id}" data-stat="steals">-</button>
                                <input class="stat-input" data-id="${player.id}" data-stat="steals" value="${player.steals||0}" readonly>
                                <button class="stat-btn plus" data-id="${player.id}" data-stat="steals">+</button>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">TAPONES</div>
                            <div class="stat-controls">
                                <button class="stat-btn minus" data-id="${player.id}" data-stat="blocks">-</button>
                                <input class="stat-input" data-id="${player.id}" data-stat="blocks" value="${player.blocks||0}" readonly>
                                <button class="stat-btn plus" data-id="${player.id}" data-stat="blocks">+</button>
                            </div>
                        </div>

                        <div class="stat-box">
                            <div class="stat-label">PÉRDIDAS</div>
                            <div class="stat-controls">
                                <button class="stat-btn minus" data-id="${player.id}" data-stat="turnovers">-</button>
                                <input class="stat-input" data-id="${player.id}" data-stat="turnovers" value="${player.turnovers||0}" readonly>
                                <button class="stat-btn plus" data-id="${player.id}" data-stat="turnovers">+</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            addStatListeners();
            addPlayerToggleListeners();
            updateToggleAllButtonText();
            updatePlayerCount();
        }

        function addStatListeners(){
            document.querySelectorAll('.stat-btn.plus').forEach(btn=>{
                btn.addEventListener('click', function(){
                    const id = parseInt(this.dataset.id);
                    const stat = this.dataset.stat;
                    updateStat(id, stat, 1);
                });
            });
            document.querySelectorAll('.stat-btn.minus').forEach(btn=>{
                btn.addEventListener('click', function(){
                    const id = parseInt(this.dataset.id);
                    const stat = this.dataset.stat;
                    updateStat(id, stat, -1);
                });
            });
        }

        function addPlayerToggleListeners(){
            document.querySelectorAll('button[data-action="toggle"]').forEach(btn=>{
                btn.addEventListener('click', function(){
                    const id = parseInt(this.dataset.id);
                    togglePlayerCollapse(id);
                });
            });
        }

        function togglePlayerCollapse(playerId){
            const p = selectedPlayers.find(pp => pp.id === playerId);
            if (p) {
                p.collapsed = !p.collapsed;
                saveCurrentGameToStorage();
                renderPlayers();
            }
        }

        function updateStat(playerId, stat, change){
            const p = selectedPlayers.find(x=>x.id===playerId);
            if(!p) return;
            p[stat] = Math.max(0, (p[stat]||0) + change);
            saveCurrentGameToStorage();
            renderPlayers();
            updateSummary();
        }

        function updateSummary(){
            const totalRebounds = selectedPlayers.reduce((s,p)=>s + ((p.orebounds||0)+(p.drebounds||0)),0);
            const totalAssists = selectedPlayers.reduce((s,p)=>s + (p.assists||0),0);
            const totalSteals = selectedPlayers.reduce((s,p)=>s + (p.steals||0),0);
            const totalBlocks = selectedPlayers.reduce((s,p)=>s + (p.blocks||0),0);
            const totalTurnovers = selectedPlayers.reduce((s,p)=>s + (p.turnovers||0),0);
            
            document.getElementById('totalRebounds').textContent = totalRebounds;
            document.getElementById('totalAssists').textContent = totalAssists;
            document.getElementById('totalSteals').textContent = totalSteals;
            document.getElementById('totalBlocks').textContent = totalBlocks;
            document.getElementById('totalTurnovers').textContent = totalTurnovers;
        }

        function saveCurrentGameToHistory(){
            gameData.date = document.getElementById('gameDate').value;
            gameData.opponent = document.getElementById('opponent').value;
            gameData.venue = document.getElementById('venue').value;
            if(!gameData.opponent){ showNotification('Introduce el rival antes de guardar','error'); return; }
            const snapshot = {
                id: Date.now(),
                date: gameData.date, 
                opponent: gameData.opponent, 
                venue: gameData.venue,
                players: JSON.parse(JSON.stringify(selectedPlayers))
            };
            gameHistory.unshift(snapshot);
            if(gameHistory.length>40) gameHistory.pop();
            localStorage.setItem('panasHistory', JSON.stringify(gameHistory));
            showNotification('Partido guardado', 'success');
            renderHistory();
        }

        function renderHistory(){
            const container = document.getElementById('historyList');
            container.innerHTML = '';
            gameHistory.forEach((g,i)=>{
                const el = document.createElement('div');
                el.className = 'history-item';
                el.innerHTML = `<div style="font-size:13px;">
                                    <strong>${g.opponent}</strong>
                                    <div style="font-size:12px;color:var(--muted)">${g.date || ''}</div>
                                </div>
                                <div class="history-actions">
                                    <button class="action-btn" data-idx="${i}" style="padding:6px 8px;font-size:12px;">Exportar</button>
                                    <button class="action-btn email-history-btn" data-idx="${i}" style="padding:6px 8px;font-size:12px;">Email</button>
                                </div>`;
                container.appendChild(el);
            });
            // binding export buttons
            container.querySelectorAll('button[data-idx]').forEach(b=>{
                b.addEventListener('click', function(){
                    const idx = parseInt(this.dataset.idx);
                    const match = gameHistory[idx];
                    if(!match) { showNotification('Partido no encontrado','error'); return; }
                    exportGameToExcel({ date: match.date, opponent: match.opponent, venue: match.venue, players: match.players });
                });
            });
            // binding email buttons
            container.querySelectorAll('.email-history-btn').forEach(b=>{
                b.addEventListener('click', function(){
                    const idx = parseInt(this.dataset.idx);
                    const match = gameHistory[idx];
                    if(!match) { showNotification('Partido no encontrado','error'); return; }
                    sendEmail({ date: match.date, opponent: match.opponent, venue: match.venue, players: match.players });
                });
            });
        }

        // Función para enviar por email (usa mailto: con body formateado)
        function sendEmail(game) {
            if(!game.players || game.players.length===0){ 
                showNotification('No hay datos para enviar','error'); 
                return; 
            }
            
            // Calcular totales
            const totals = game.players.reduce((acc, p) => {
                acc.ore += (p.orebounds || 0);
                acc.dre += (p.drebounds || 0);
                acc.as += (p.assists || 0);
                acc.st += (p.steals || 0);
                acc.bl += (p.blocks || 0);
                acc.to += (p.turnovers || 0);
                return acc;
            }, { ore:0, dre:0, as:0, st:0, bl:0, to:0});
            
            // Construir el asunto
            const subject = `Estadísticas PANAS vs ${game.opponent} - ${game.date}`;
            
            // Construir el cuerpo del email (texto plano)
            let body = `Estadísticas del partido PANAS vs ${game.opponent}\n\n`;
            body += `Fecha: ${game.date}\n`;
            body += `Lugar: ${game.venue}\n\n`;
            body += `RESUMEN DEL PARTIDO:\n`;
            body += `Rebotes totales: ${totals.ore + totals.dre}\n`;
            body += `Rebotes ofensivos: ${totals.ore}\n`;
            body += `Rebotes defensivos: ${totals.dre}\n`;
            body += `Asistencias: ${totals.as}\n`;
            body += `Robos: ${totals.st}\n`;
            body += `Tapones: ${totals.bl}\n`;
            body += `Pérdidas: ${totals.to}\n\n`;
            body += `ESTADÍSTICAS POR JUGADOR:\n\n`;
            
            // Añadir estadísticas de cada jugador
            game.players.forEach(p => {
                body += `${p.number} - ${p.name}:\n`;
                body += `  Reb. ofensivos: ${p.orebounds || 0}\n`;
                body += `  Reb. defensivos: ${p.drebounds || 0}\n`;
                body += `  Asistencias: ${p.assists || 0}\n`;
                body += `  Robos: ${p.steals || 0}\n`;
                body += `  Tapones: ${p.blocks || 0}\n`;
                body += `  Pérdidas: ${p.turnovers || 0}\n\n`;
            });
            
            // Codificar para URL
            const encodedSubject = encodeURIComponent(subject);
            const encodedBody = encodeURIComponent(body);
            
            // Dirección fija
            const mailtoLink = `mailto:cbpanasymankos2022@gmail.com?subject=${encodedSubject}&body=${encodedBody}`;
            
            // Abrir cliente de correo
            window.location.href = mailtoLink;
            
            showNotification('Abriendo cliente de correo...', 'success');
        }

        function exportGameToExcel(game){
            if(!game.players || game.players.length===0){ showNotification('No hay datos para exportar','error'); return; }
            try{
                const rows = [];
                rows.push(['Partido', `PANAS vs ${game.opponent || ''}`]);
                rows.push(['Fecha', game.date || '']);
                rows.push(['Lugar', game.venue || '']);
                rows.push([]);
                rows.push(['Número','Jugador','Reb. O','Reb. D','Reb. Total','Asistencias','Robos','Tapones','Pérdidas']);
                game.players.forEach(p=>{
                    const o = p.orebounds||0, d = p.drebounds||0;
                    rows.push([p.number || '', p.name || '', o, d, o+d, p.assists||0, p.steals||0, p.blocks||0, p.turnovers||0]);
                });
                const totals = game.players.reduce((acc,p)=>{
                    acc.ore += (p.orebounds||0);
                    acc.dre += (p.drebounds||0);
                    acc.as += (p.assists||0);
                    acc.st += (p.steals||0);
                    acc.bl += (p.blocks||0);
                    acc.to += (p.turnovers||0);
                    return acc;
                }, {ore:0,dre:0,as:0,st:0,bl:0,to:0});
                rows.push([]);
                rows.push(['Totales','','', '', totals.ore + totals.dre, totals.as, totals.st, totals.bl, totals.to]);

                const worksheet = XLSX.utils.aoa_to_sheet(rows);
                worksheet['!cols'] = [{wch:6},{wch:22},{wch:8},{wch:8},{wch:10},{wch:12},{wch:8},{wch:8},{wch:9}];
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Estadísticas');
                const wbout = XLSX.write(workbook, {bookType:'xlsx', type:'array'});
                const blob = new Blob([wbout], {type:'application/octet-stream'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const safeOpponent = (game.opponent || 'PANAS').replace(/[^a-z0-9]/gi,'_');
                a.download = `PANAS_${safeOpponent}_${game.date || 'sin_fecha'}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }catch(e){
                console.error(e);
                showNotification('Error al generar Excel','error');
            }
        }

        function resetGame(){
            if(selectedPlayers.length > 0 && !confirm('¿Estás seguro de que quieres reiniciar el partido actual? Se perderán todos los datos.')) {
                return;
            }
            selectedPlayers = [];
            gameData = {date:'',opponent:'',venue:''};
            document.getElementById('gameDate').value = '';
            document.getElementById('opponent').value = '';
            document.getElementById('venue').value = '';
            saveCurrentGameToStorage();
            renderPlayerChips();
            renderPlayers();
            updateSummary();
            showNotification('Partido reiniciado', 'success');
        }

        // Guardar partido actual en storage
        function saveCurrentGameToStorage(){
            try{
                localStorage.setItem('panasCurrentGame', JSON.stringify({ gameData: {
                    date: document.getElementById('gameDate')?.value || '', 
                    opponent: document.getElementById('opponent')?.value || '',
                    venue: document.getElementById('venue')?.value || ''
                }, players: selectedPlayers }));
            }catch(e){}
        }

        // Toggle sección info (fecha/rival/lugar/chips)
        function toggleInfoSection(){
            const infoSection = document.getElementById('infoSection');
            const btn = document.getElementById('infoCollapseBtn');
            infoSection.classList.toggle('info-collapsed');
            const hidden = infoSection.classList.contains('info-collapsed');
            btn.textContent = hidden ? 'Mostrar' : 'Ocultar';
        }

        // Toggle todos los jugadores (contraer/expandir)
        function toggleAllPlayers() {
            if (selectedPlayers.length === 0) return;
            const allCollapsed = selectedPlayers.every(p => p.collapsed === true);
            const newState = !allCollapsed; // if all collapsed -> newState = false (expand); otherwise collapse all (true)
            selectedPlayers = selectedPlayers.map(p => ({ ...p, collapsed: newState }));
            saveCurrentGameToStorage();
            renderPlayers();
            updateToggleAllButtonText();
        }

        function updateToggleAllButtonText() {
            const btn = document.getElementById('toggleAllPlayersBtn');
            if (!btn) return;
            if (selectedPlayers.length === 0) {
                btn.textContent = 'Contraer todos';
                btn.disabled = true;
                btn.style.opacity = '0.6';
                return;
            }
            btn.disabled = false;
            btn.style.opacity = '1';
            const allCollapsed = selectedPlayers.every(p => p.collapsed === true);
            // if all collapsed -> show "Expandir todos" (because action is expand)
            btn.textContent = allCollapsed ? 'Expandir todos' : 'Contraer todos';
        }

        // Limpiar historial
        function clearHistory(){
            if(!confirm('¿Borrar todo el historial?')) return;
            gameHistory = [];
            localStorage.removeItem('panasHistory');
            renderHistory();
            showNotification('Historial limpiado', 'success');
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', ()=>{
            // Cargar historial
            const savedHist = localStorage.getItem('panasHistory');
            if(savedHist){ try{ gameHistory = JSON.parse(savedHist); }catch(e){ gameHistory = []; } }

            // Cargar juego actual
            const savedGame = localStorage.getItem('panasCurrentGame');
            if(savedGame){
                try{
                    const parsed = JSON.parse(savedGame);
                    // al cargar, forzamos collapsed:true por defecto si no viene explícito
                    selectedPlayers = (parsed.players || []).map(p => ({ ...p, collapsed: p.collapsed !== undefined ? p.collapsed : true }));
                    gameData = parsed.gameData || gameData;
                    document.getElementById('gameDate').value = gameData.date || '';
                    document.getElementById('opponent').value = gameData.opponent || '';
                    document.getElementById('venue').value = gameData.venue || '';
                }catch(e){}
            }

            // Establecer fecha actual si no hay fecha
            if (!document.getElementById('gameDate').value) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('gameDate').value = today;
            }

            renderPlayerChips();
            renderPlayers();
            renderHistory();
            updateSummary();

            // Listeners
            document.getElementById('exportBtn').addEventListener('click', ()=> {
                gameData.date = document.getElementById('gameDate').value;
                gameData.opponent = document.getElementById('opponent').value;
                gameData.venue = document.getElementById('venue').value;
                exportGameToExcel({ date: gameData.date, opponent: gameData.opponent, venue: gameData.venue, players: selectedPlayers });
            });
            
            document.getElementById('emailBtn').addEventListener('click', ()=> {
                gameData.date = document.getElementById('gameDate').value;
                gameData.opponent = document.getElementById('opponent').value;
                gameData.venue = document.getElementById('venue').value;
                if (!gameData.opponent) {
                    showNotification('Introduce el rival antes de enviar el email', 'error');
                    return;
                }
                if (selectedPlayers.length === 0) {
                    showNotification('No hay jugadores seleccionados', 'error');
                    return;
                }
                sendEmail({ date: gameData.date, opponent: gameData.opponent, venue: gameData.venue, players: selectedPlayers });
            });
            
            document.getElementById('saveGameBtn').addEventListener('click', saveCurrentGameToHistory);
            document.getElementById('resetGameBtn').addEventListener('click', resetGame);
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('infoCollapseBtn').addEventListener('click', toggleInfoSection);
            document.getElementById('toggleAllPlayersBtn').addEventListener('click', toggleAllPlayers);

            // Auto-save current game on changes
            document.getElementById('gameDate').addEventListener('change', saveCurrentGameToStorage);
            document.getElementById('opponent').addEventListener('input', saveCurrentGameToStorage);
            document.getElementById('venue').addEventListener('input', saveCurrentGameToStorage);

            // Auto-save current game on unload as fallback
            window.addEventListener('beforeunload', ()=>{
                saveCurrentGameToStorage();
            });

            // Inicializa texto del botón global
            updateToggleAllButtonText();
        });
    </script>
</body>
</html>
